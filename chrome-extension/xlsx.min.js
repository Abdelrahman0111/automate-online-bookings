// قراءة ملف Excel بدون مكتبات خارجية - للملفات البسيطة فقط
function readExcelFile(arrayBuffer) {
    try {
        // تحويل ArrayBuffer إلى Uint8Array
        const data = new Uint8Array(arrayBuffer);
        
        // البحث عن بيانات XML في ملف Excel
        let xmlString = '';
        for (let i = 0; i < data.length - 100; i++) {
            // البحث عن بداية worksheet
            if (data[i] === 0x3C && data[i+1] === 0x77 && data[i+2] === 0x6F && data[i+3] === 0x72) { // <wor
                // استخراج جزء من البيانات
                const chunk = data.slice(i, i + 10000);
                xmlString = new TextDecoder().decode(chunk);
                break;
            }
        }
        
        // إذا لم نجد XML، نحاول قراءة كـ CSV
        if (!xmlString) {
            const textData = new TextDecoder().decode(data);
            return parseCSVLike(textData);
        }
        
        // محاولة استخراج البيانات من XML
        return parseExcelXML(xmlString);
        
    } catch (error) {
        console.error('خطأ في قراءة ملف Excel:', error);
        
        // في حالة الفشل، محاولة قراءة كـ text
        try {
            const textData = new TextDecoder().decode(arrayBuffer);
            return parseCSVLike(textData);
        } catch (e) {
            console.error('فشل في قراءة الملف كـ text أيضاً:', e);
            return [];
        }
    }
}

function parseCSVLike(text) {
    try {
        // البحث عن ClientReference و HotelConf في النص
        const lines = text.split('\n');
        const results = [];
        
        let clientRefIndex = -1;
        let hotelConfIndex = -1;
        
        // البحث عن headers
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.includes('ClientReference') && line.includes('HotelConf')) {
                const headers = line.split(/[,\t]/);
                clientRefIndex = headers.findIndex(h => h.includes('ClientReference'));
                hotelConfIndex = headers.findIndex(h => h.includes('HotelConf'));
                
                // قراءة البيانات من السطور التالية
                for (let j = i + 1; j < lines.length && j < i + 100; j++) {
                    const dataLine = lines[j];
                    if (dataLine.trim()) {
                        const values = dataLine.split(/[,\t]/);
                        if (values.length > Math.max(clientRefIndex, hotelConfIndex)) {
                            const clientRef = values[clientRefIndex]?.trim().replace(/"/g, '');
                            const hotelConf = values[hotelConfIndex]?.trim().replace(/"/g, '');
                            
                            if (clientRef && hotelConf && !isNaN(clientRef)) {
                                results.push({
                                    ClientReference: clientRef,
                                    HotelConf: hotelConf
                                });
                            }
                        }
                    }
                }
                break;
            }
        }
        
        console.log('تم استخراج', results.length, 'سجل من النص');
        return results;
        
    } catch (error) {
        console.error('خطأ في تحليل CSV:', error);
        return [];
    }
}

function parseExcelXML(xmlString) {
    try {
        // محاولة بسيطة لاستخراج البيانات من XML
        const results = [];
        
        // البحث عن أرقام تبدو مثل ClientReference (أرقام طويلة)
        const numberMatches = xmlString.match(/\b\d{8,12}\b/g);
        
        if (numberMatches && numberMatches.length >= 2) {
            // افتراض أن كل رقمين متتاليين هما ClientReference و HotelConf
            for (let i = 0; i < numberMatches.length - 1; i += 2) {
                results.push({
                    ClientReference: numberMatches[i],
                    HotelConf: numberMatches[i + 1]
                });
            }
        }
        
        console.log('تم استخراج', results.length, 'سجل من XML');
        return results;
        
    } catch (error) {
        console.error('خطأ في تحليل XML:', error);
        return [];
    }
}